<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Arena v2.1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a15;
            color: #e0e0ff;
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
        }
        #gameCanvas {
            display: block;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(18, 18, 37, 0.95);
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            border: 1px solid #2a2a45;
            z-index: 100;
        }
        #ui h3 {
            color: #00f2ff;
            margin-bottom: 10px;
            font-size: 15px;
        }
        .stat {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        .stat-label { color: #b0b0d0; }
        .stat-value { color: #00ff9d; font-weight: bold; }
        #status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
            font-size: 11px;
        }
        #errorBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 90%;
            width: 500px;
            background: rgba(255, 85, 119, 0.95);
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 1000;
            border: 2px solid #ff5577;
            box-shadow: 0 0 20px rgba(255, 85, 119, 0.5);
        }
        #errorBox h2 {
            margin-bottom: 10px;
            color: #fff;
        }
        #errorBox pre {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 11px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        button {
            margin-top: 10px;
            padding: 10px 20px;
            background: #00f2ff;
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
        }
        button:hover { background: #00c4d4; }
        button:disabled { background: #444; color: #888; cursor: not-allowed; }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui">
        <h3>üéÆ AI Arena v2.1</h3>
        <div class="stat">
            <span class="stat-label">Step:</span>
            <span class="stat-value" id="stepStat">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">Agents:</span>
            <span class="stat-value" id="agentStat">0</span>
        </div>
        <div class="stat">
            <span class="stat-label">FPS:</span>
            <span class="stat-value" id="fpsStat">0</span>
        </div>
        <div id="status">‚è≥ Loading...</div>
        <button id="btnStart" disabled>‚ñ∂ Start</button>
        <button id="btnReset" disabled>üîÑ Reset</button>
    </div>

    <div id="errorBox" style="display: none;">
        <h2>‚ùå ERROR</h2>
        <div id="errorMsg"></div>
        <pre id="errorStack"></pre>
        <button onclick="document.getElementById('errorBox').style.display='none'" style="margin-top: 15px;">Close</button>
    </div>

    <script>
        // === –ü–û–ö–ê–ó–ê–¢–¨ –û–®–ò–ë–ö–£ ===
        function showError(title, message, stack) {
            document.getElementById('errorBox').style.display = 'block';
            document.getElementById('errorMsg').innerHTML = '<strong>' + title + '</strong><br><br>' + message;
            document.getElementById('errorStack').textContent = stack || '';
            document.getElementById('status').textContent = '‚ùå Error';
            document.getElementById('status').style.background = 'rgba(255, 85, 119, 0.2)';
            document.getElementById('status').style.color = '#ff5577';
        }

        // === –ü–ï–†–ï–•–í–ê–¢ –í–°–ï–• –û–®–ò–ë–û–ö ===
        window.onerror = function(msg, url, line, col, error) {
            showError('JavaScript Error', msg, error ? error.stack : 'Line ' + line);
            return false;
        };

        window.addEventListener('unhandledrejection', function(event) {
            showError('Promise Error', event.reason, event.reason ? event.reason.stack : '');
        });

        console.log('=== AI Arena Starting ===');
    </script>

    <script type="module">
        try {
            console.log('Step 1: Importing Cortex2Brain from ./core/cortex.js');
            document.getElementById('status').textContent = 'üì¶ Loading Cortex...';
            
            const cortexModule = await import('./core/cortex.js');
            const { Cortex2Brain } = cortexModule;
            console.log('‚úÖ Cortex2Brain loaded:', Cortex2Brain);
            document.getElementById('status').textContent = '‚úÖ Cortex loaded!';

            console.log('Step 2: Importing GameEngine from ./game.js');
            document.getElementById('status').textContent = 'üì¶ Loading Game...';
            
            const gameModule = await import('./game.js');
            const { GameEngine } = gameModule;
            console.log('‚úÖ GameEngine loaded:', GameEngine);
            document.getElementById('status').textContent = '‚úÖ Game loaded!';

            console.log('Step 3: Initializing canvas');
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            console.log('Canvas size:', canvas.width, 'x', canvas.height);

            console.log('Step 4: Creating engine');
            document.getElementById('status').textContent = 'üéÆ Creating engine...';
            
            const engine = await new GameEngine({
                width: canvas.width,
                height: canvas.height,
                seed: 'arena_1'
            }).init();
            console.log('‚úÖ Engine created:', engine);
            document.getElementById('status').textContent = '‚úÖ Engine ready!';

            console.log('Step 5: Adding agents');
            document.getElementById('status').textContent = 'ü§ñ Creating agents...';
            
            engine.addAgent({
                id: 'blue',
                x: 200,
                y: 300,
                color: '#00d4ff',
                stats: { maxHealth: 100, damage: 3, speed: 22 }
            });

            engine.addAgent({
                id: 'red',
                x: 620,
                y: 300,
                color: '#ff5577',
                stats: { maxHealth: 100, damage: 3, speed: 22 }
            });
            
            document.getElementById('agentStat').textContent = engine.agents.size;
            console.log('‚úÖ Agents created:', engine.agents.size);
            document.getElementById('status').textContent = '‚úÖ Agents ready!';

            console.log('Step 6: Creating brains');
            document.getElementById('status').textContent = 'üß† Creating brains...';
            
            const brains = new Map();
            for (const [id, agent] of engine.agents) {
                const brain = new Cortex2Brain({
                    seed: `brain_${id}`,
                    taskSpec: {
                        inputComplexity: 0.7,
                        temporalDepth: 0.4,
                        socialComplexity: 0.8
                    }
                });

                brain.configurePersonality({
                    traits: {
                        bravery: Math.random() * 0.6 + 0.2,
                        aggression: Math.random() * 0.6 + 0.2,
                        empathy: Math.random() * 0.5
                    }
                });

                brains.set(id, brain);
            }
            console.log('‚úÖ Brains created:', brains.size);
            document.getElementById('status').textContent = '‚úÖ Brains ready!';

            // Game loop
            let running = false;
            let lastTime = 0;
            let frameCount = 0;
            let fps = 0;

            function gameLoop(timestamp) {
                if (!running) return;

                const dt = Math.min((timestamp - lastTime) / 1000, 0.1);
                lastTime = timestamp;

                try {
                    engine.step(dt);

                    for (const [id, agent] of engine.agents) {
                        if (!agent.alive) continue;
                        const brain = brains.get(id);
                        if (!brain) continue;
                        
                        const sensors = getSensors(agent, engine);
                        const result = brain.forward(sensors, 0, null, {
                            others: getSocialContext(agent, engine)
                        });

                        agent.setThrottle(result.output[4]);
                        agent.setSteering(result.output[8]);
                        if (result.output[6] > 0.7) {
                            agent.requestAttack();
                        }
                    }

                    engine.render(ctx, { showGrid: true, showTrail: true });

                    frameCount++;
                    if (frameCount % 30 === 0) {
                        fps = Math.round(1 / dt);
                        document.getElementById('stepStat').textContent = engine.stepCount;
                        document.getElementById('fpsStat').textContent = fps;
                    }
                } catch (e) {
                    console.error('Game loop error:', e);
                    showError('Game Loop Error', e.message, e.stack);
                }

                requestAnimationFrame(gameLoop);
            }

            // Controls
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnReset').disabled = false;
            document.getElementById('status').textContent = '‚úÖ READY! Press Start';
            document.getElementById('status').style.background = 'rgba(0, 255, 157, 0.2)';
            document.getElementById('status').style.color = '#00ff9d';

            document.getElementById('btnStart').onclick = () => {
                running = !running;
                if (running) {
                    lastTime = performance.now();
                    requestAnimationFrame(gameLoop);
                    document.getElementById('btnStart').textContent = '‚è∏ Pause';
                    document.getElementById('status').textContent = '‚ñ∂ Running';
                } else {
                    document.getElementById('btnStart').textContent = '‚ñ∂ Start';
                    document.getElementById('status').textContent = '‚è∏ Paused';
                }
            };

            document.getElementById('btnReset').onclick = () => {
                engine.reset();
                for (const brain of brains.values()) {
                    brain.resetEpisode();
                }
                document.getElementById('status').textContent = 'üîÑ Reset';
            };

            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                engine.config.width = canvas.width;
                engine.config.height = canvas.height;
            });

            // Utils
            window.Utils = {
                clamp: (v, min, max) => Math.max(min, Math.min(max, v)),
                dist: (a, b) => Math.hypot((a?.x ?? 0) - (b?.x ?? 0), (a?.y ?? 0) - (b?.y ?? 0)),
                angleToTarget: (fromX, fromY, toX, toY, facing) => {
                    let angle = Math.atan2(toY - fromY, toX - fromX) - facing;
                    while (angle > Math.PI) angle -= Math.PI * 2;
                    while (angle < -Math.PI) angle += Math.PI * 2;
                    return angle;
                }
            };

            function getSensors(agent, engine) {
                const sensors = new Array(64).fill(0);
                let nearestEnemy = null, nearestDist = Infinity;
                
                for (const [id, other] of engine.agents) {
                    if (other === agent || !other.alive) continue;
                    const dist = Utils.dist(agent, other);
                    if (dist < nearestDist) { nearestDist = dist; nearestEnemy = other; }
                }

                if (nearestEnemy) {
                    sensors[0] = (nearestEnemy.x - agent.x) / 400;
                    sensors[1] = (nearestEnemy.y - agent.y) / 300;
                    sensors[2] = nearestDist / 200;
                    sensors[3] = nearestEnemy.health / nearestEnemy.stats.maxHealth;
                }

                let nearestWall = null, nearestWallDist = Infinity;
                for (const wall of engine.world.walls) {
                    const dist = Utils.dist(agent, wall);
                    if (dist < nearestWallDist) { nearestWallDist = dist; nearestWall = wall; }
                }

                if (nearestWall) {
                    sensors[4] = (nearestWall.x - agent.x) / 400;
                    sensors[5] = (nearestWall.y - agent.y) / 300;
                    sensors[6] = nearestWallDist / 100;
                }

                sensors[7] = agent.x / 820;
                sensors[8] = agent.y / 600;
                sensors[9] = agent.health / agent.stats.maxHealth;
                sensors[10] = agent.vx / 25;
                sensors[11] = agent.vy / 25;

                return sensors;
            }

            function getSocialContext(agent, engine) {
                const others = [];
                for (const [id, other] of engine.agents) {
                    if (other === agent || !other.alive) continue;
                    others.push({
                        id: other.id,
                        distance: Utils.dist(agent, other),
                        healthRatio: other.health / other.stats.maxHealth,
                        aggression: 0.5
                    });
                }
                return { others, enemyId: others[0]?.id };
            }

            console.log('=== All initialized successfully! ===');

        } catch (error) {
            console.error('Initialization error:', error);
            showError('Initialization Failed', error.message, error.stack);
        }
    </script>
</body>
</html>

